\documentclass[12pt,a4paper]{article}
\usepackage[utf8]{inputenc}
\usepackage{geometry}
\usepackage{graphicx}
\usepackage{xcolor}
\usepackage{titlesec}
\usepackage{fancyhdr}
\usepackage{enumitem}
\usepackage{pgfplots}
\usepackage{fontspec}
\usepackage{setspace}
\usepackage{tabularx}
\usepackage{tikz}
\usepackage[absolute,overlay]{textpos}
\pgfplotsset{compat=1.18}

% Define custom colors
\definecolor{hydrosensblue}{RGB}{37, 51, 114}
\definecolor{hydrosenscyan}{RGB}{81, 186, 215}

% Page margins
\geometry{
    top=2cm,
    bottom=2cm,
    left=2cm,
    right=2cm
}

% Load custom fonts
\newfontfamily\titlefont[
  Path = assets/fonts/,
  UprightFont = JosefinSlab-Regular,
  BoldFont = JosefinSlab-Bold
]{Josefin Slab}

\newfontfamily\subtitlefont[
  Path = assets/fonts/,
  UprightFont = LibreBaskerville-Regular,
  BoldFont = LibreBaskerville-Bold
]{Libre Baskerville}

\newfontfamily\contentfont[
  Path = assets/fonts/,
  UprightFont = LibreBaskerville-Regular
]{Libre Baskerville}

% Custom styling commands
\newcommand{\HydroTitle}[1]{%
    {\titlefont\color{hydrosensblue}\bfseries\fontsize{60pt}{40pt}\selectfont #1}
}

\newcommand{\HydroSubtitle}[1]{%
    {\subtitlefont\color{hydrosensblue}\bfseries\fontsize{16pt}{20pt}\selectfont #1}
}

\newcommand{\HydroContent}[1]{%
{\contentfont\color{black}\normalfont\fontsize{16pt}{20pt}\selectfont #1}
}

% Fancy header/footer
\pagestyle{fancy}
\fancyhead{}
\fancyfoot{}
\renewcommand{\headrulewidth}{0pt}
\renewcommand{\footrulewidth}{0pt}

% Section title formatting
\titleformat{\section}
  {\normalfont\Large\bfseries\color{hydrosensblue}\titlefont}
  {}
  {0em}
  {}[\titlerule]

\titleformat{\subsection}
  {\normalfont\large\bfseries\color{hydrosenscyan}\subtitlefont}
  {}
  {0em}
  {}

% Document begin
\begin{document}
% Title page
\begin{titlepage}
\begin{center}
\begin{minipage}{0.75\textwidth}
    \raggedright
    \HydroTitle{RSS-Hydro\vspace{0.5cm}}\\[0.1cm]
    \HydroTitle{HYDROSENS}
\end{minipage}
\hfill
\begin{minipage}{0.15\textwidth}
    \includegraphics[width=\linewidth]{assets/images/logo.png}
\end{minipage}
\end{center}

% Separator line
\vspace{0.5\baselineskip}
\noindent\color{hydrosenscyan}\rule{0.25\textwidth}{3pt}
\vspace{1\baselineskip}

% Subtitle
\noindent
\HydroSubtitle{ENVIRONMENTAL MONITORING REPORT}

\vspace{1cm}

% Region and Time Period
\noindent
\HydroSubtitle{AREA OF INTEREST:}
\HydroContent{\VAR{ location | e }}

\vspace{0.2cm}

\noindent
\HydroSubtitle{\textbf{TIME PERIOD:}}
\HydroContent{\VAR{ time_period | e }}

\vfill

% Decorative Image with circle crop at bottom right
\begin{tikzpicture}[remember picture, overlay]
    % === Background block (hydrosenscyan), half the height of the circle ===
    \fill[hydrosenscyan]
        ([xshift=-\paperwidth,yshift=10cm]current page.south east) rectangle
        ([xshift=0cm,yshift=0cm]current page.south east); % 2cm height = half of 4cm radius circle

    % === Circular clipped image ===
    \begin{scope}
        \clip (current page.south east) ++(-4cm, 4cm) circle (20cm); % Adjust position and size
        \node at ([xshift=-7cm, yshift=7cm]current page.south east)
            {\includegraphics[width=20cm]{assets/images/intro.png}}; % Adjust image width
    \end{scope}
\end{tikzpicture}
\end{titlepage}

% Overview Page
\noindent
\HydroTitle{OVERVIEW}

\vspace{0.3cm}

% Light blue line under the heading
\vspace{0.5\baselineskip}
\noindent\color{hydrosenscyan}\rule{0.25\textwidth}{3pt}
\vspace{1\baselineskip}

% Body text
\noindent   
\begingroup
  \setstretch{1.5}%
  \contentfont
  \color{black}%
  \normalfont
  \fontsize{16pt}{20pt}\selectfont
\VAR{ overview | e }
\par
\endgroup

\begin{figure}[h!]
    \centering
    \includegraphics[width=\textwidth]{\VAR{ region_screenshot_path | e }}
    \caption{\textit{Area of Interest}}
\end{figure}

% Key insights page
\clearpage
\noindent
\begin{minipage}[t]{0.6\textwidth}

\HydroTitle{KEY\vspace{0.5cm}}\\ % Adds vertical space *inside* the title box
\HydroTitle{INSIGHTS}

  \vspace{0.5\baselineskip}
  \color{hydrosenscyan}\rule{0.25\textwidth}{3pt}
  \vspace{1\baselineskip}

  \setstretch{1.5}
  \raggedright
  \BLOCK{ for insight in key_insights }
  \HydroContent{\textbf{\VAR{ loop.index }. \VAR{ insight.title | e }}\\
  \VAR{ insight.detail | e }}

  \vspace{0.6cm}
  \BLOCK{ endfor }
\end{minipage}%
\hfill
\begin{minipage}[t]{0.25\textwidth}
% Background image on right half
\begin{tikzpicture}[remember picture,overlay]
  \node[anchor=north east, inner sep=0pt] at (current page.north east)
    {\includegraphics[height=\paperheight]{assets/images/waterfall.png}};
\end{tikzpicture}

\end{minipage}

% Metric pages
\BLOCK{ for metric in metrics }
\BLOCK{ if metric.selected }
\clearpage
% Top border line
\vspace*{-0.5cm}
\noindent
\color{teal}\rule{\textwidth}{2pt}
\vspace{0.1cm}
% Header
\noindent
\begin{tabular*}{\textwidth}{@{\extracolsep{\fill}} l }
\textsf{\textbf{\small STATISTICS}} \\
\end{tabular*}
\vspace{0.2cm}
% Title section
\noindent 
\begin{minipage}[t]{\textwidth}
\begingroup
  \setstretch{1.5}%
  \titlefont
  \color{hydrosensblue}%
  \fontsize{40pt}{30pt}
  \bfseries\selectfont
  \noindent  
\raggedright
  \BLOCK{ set words = metric.title.upper().split() }
  \BLOCK{ for word in words }\mbox{\VAR{word|e}}
  \BLOCK{ if not loop.last } \BLOCK{ endif }\BLOCK{ endfor }
\par
\endgroup
\vspace{0.3cm}
\par \textit{\VAR{ metric.description | e }}
\end{minipage}
\vspace{0.5cm}
% Numbers section - Trend and Mean Value in a row
\noindent
\begin{tabularx}{\textwidth}{@{}X X@{}}
  % Trend Section (Left)
  \begin{minipage}[t]{0.45\textwidth}
    {\subtitlefont\color{hydrosenscyan}\bfseries\fontsize{42pt}{32pt}\selectfont \VAR{ metric.trend.percent | e }\%}
    \begin{tikzpicture}[baseline=(current bounding box.base)]
      \BLOCK{ if metric.trend.uptrend }
      % Up arrow for increasing trend
      \draw[hydrosenscyan, line width=6pt, ->, >=stealth] (0,0) -- (0.45,0.65) -- (0.75,0.35) -- (1.2,1.1);
      \BLOCK{ else }
      % Down arrow for decreasing trend
      \draw[hydrosenscyan, line width=6pt, ->, >=stealth] (0,1.1) -- (0.45,0.45) -- (0.75,0.75) -- (1.2,0);
      \BLOCK{ endif }
    \end{tikzpicture}\\[0.2cm]
    \noindent\color{hydrosenscyan}\rule{5.2cm}{2pt}
    \vspace{0.3cm}
    \setstretch{1.5}
    \HydroSubtitle{\textbf{TREND}}\\[-0.3cm]
  \end{minipage}
  &
  % Mean Value Section (Right)
  \begin{minipage}[t]{0.45\textwidth}
    {\subtitlefont\color{hydrosenscyan}\bfseries\fontsize{42pt}{32pt}\selectfont \VAR{ "%.2f"|format(metric.mean_value) | e }}\\[0.2cm]
    \noindent\color{hydrosenscyan}\rule{5.2cm}{2pt}\\[0.2cm]
    \vspace{0.3cm}
    \HydroSubtitle{\textbf{MEAN VALUE}}\\[-0.3cm]
    \setstretch{1.5}
  \end{minipage}
\end{tabularx}
\vspace{0.2cm}

% Chart section - full width
\noindent
\begin{figure}[h!]
    \centering
    \includegraphics[width=\textwidth]{\VAR{ metric.graph_image_path | e }}
    \caption{{\VAR{ metric.title | e }} time series}
\end{figure}
\vspace{0.5cm}

% Time Series Insight section - full width, below chart
\noindent
\begin{minipage}[t]{\textwidth}
  \HydroSubtitle{TIME SERIES INSIGHT}\\[-0.5ex]
  \noindent\color{hydrosenscyan}\rule{6cm}{2pt}\\[0.2cm]
  \setstretch{1.5}
  \HydroContent{\VAR{ metric.time_insight | e }}
\end{minipage}
\vfill
% Page number at bottom right
\vspace{0.2cm}
% Bottom border line
\noindent\color{teal}\rule{\textwidth}{2pt}
\vspace{0.2cm}
\noindent
\begin{tabular*}{\textwidth}{@{\extracolsep{\fill}} l r }
 & \textsf{\textbf{\small PAGE \VAR{ "%02d"|format(loop.index + 4) }}} \\
\end{tabular*}

\BLOCK{ endif }
\BLOCK{ endfor }

\end{document}